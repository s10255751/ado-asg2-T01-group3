name: Snowflake SQL Automation Pipeline

on:
  push:
    branches:
      - main  # Trigger the workflow on push to the main branch
  pull_request:
    branches:
      - main  # Trigger the workflow on pull requests to the main branch

jobs:
  run-sql-scripts:
    runs-on: ubuntu-latest  # Use a Linux-based runner

    steps:
      # Checkout the repository to get the code
      - name: Checkout repository
        uses: actions/checkout@v2

      # Download the SnowSQL installer
      - name: Download SnowSQL
        run: |
          curl -O https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/snowsql-1.2.9-linux_x86_64.bash

      # Install SnowSQL
      - name: Install SnowSQL
        run: |
          SNOWSQL_DEST=~/snowflake SNOWSQL_LOGIN_SHELL=~/.profile bash snowsql-1.2.9-linux_x86_64.bash

      # Debug: Check if snowsql was installed correctly
      - name: Verify installation
        run: |
          # Check if the snowsql binary exists in the expected location
          ls -la ~/snowflake/

          # Confirm the presence of snowsql
          if [ ! -f ~/snowflake/snowsql ]; then
            echo "SnowSQL was not installed correctly!"
            exit 1
          fi

          # Add SnowSQL to PATH
          echo "export PATH=\$PATH:~/snowflake" >> $GITHUB_ENV

          # Verify that snowsql is now available
          snowsql -v

      # Set up Snowflake credentials
      - name: Set up Snowflake credentials
        run: |
          echo "[connections.default]" > $HOME/.snowsql/config
          echo "accountname = ${SNOWFLAKE_ACCOUNT}" >> $HOME/.snowsql/config
          echo "username = ${SNOWFLAKE_USER}" >> $HOME/.snowsql/config
          echo "password = ${SNOWFLAKE_PASSWORD}" >> $HOME/.snowsql/config
          echo "dbname = ${SNOWFLAKE_DATABASE}" >> $HOME/.snowsql/config
          echo "warehouse = ${SNOWFLAKE_WAREHOUSE}" >> $HOME/.snowsql/config
          echo "schemaname = ${SNOWFLAKE_SCHEMA}" >> $HOME/.snowsql/config

      # Run SQL scripts from the repository
      - name: Run SQL scripts in Snowflake
        run: |
          snowsql -c default -f ./sql/country.sql
          snowsql -c default -f ./sql/customers.sql
          snowsql -c default -f ./sql/facebook_ads.sql
          snowsql -c default -f ./sql/order.sql
          snowsql -c default -f ./sql/order_details.sql
          snowsql -c default -f ./sql/payments.sql
          snowsql -c default -f ./sql/product_reviews.sql
          snowsql -c default -f ./sql/region.sql
          snowsql -c default -f ./sql/vendors.sql
          # Add other SQL scripts here if necessary

